# Copilot / AI agent instructions — xsd2js

Purpose: give an AI agent the minimal, precise context needed to make correct code changes quickly.

Quick start

- Install deps: `npm install`
- Run tests: `npm test` (Vitest). Run a single test: `npx vitest path/to/test.js`
- Run CLI locally: `node ./src/main.js -i examples/UANodeSet.xsd -o ./examples/generated -m`

Big picture (1-paragraph)

- xsd2js is an ESM Node CLI that reads an XSD, extracts types, and generates JS classes. The generator produces classes that extend a template `Base` which implements `fromXML`/`toXML`/`toObject`. XML parsing uses `xml2js` + a local normalizer that converts xml2js {$, _, $$} into attributes (`@_name`), text (`#text`) and grouped children.

Key files and responsibilities

- `src/main.js` — CLI entry, orchestrates parsing and generation.
- `src/generator.js` — produces class source code and metadata. Edit this to change constructor output, dependency imports, and emitted metadata keys (`isAny`, `xmlName`, `xsdType`, `isAttribute`, `isList`).
- `src/propertyExtractor.js` — maps XSD constructs to properties; modify here to support new XSD constructs (xs:any, groups, attributeGroups).
- `src/xmlNormalizer.js` — canonical normalizer converting xml2js explicitChildren output into the internal shape used by constructors and `Base`.
- `template/base.js` — template copied into generated output as `Base.js`; must be self-contained. Changes here affect runtime parsing/serialization in generated code.
- `src/writer.js` — controls copying templates/helpers into generated output (single vs multiple file modes).
- `test/` and `test/generated-unit/` — tests and sample generated classes.
- `test/generated-unit/` serves as a reference of expected generated output. As this content is generated by the script, don't modify it (it will be replaced thru build or test)

Important runtime conventions (XML ↔ JS)

- Attributes: keys prefixed with `@_` by default (e.g. `@_Locale`). `--transparent-attributes` toggles exposing them without `@_`.
- Text content: stored under `#text`. Constructors should prefer `data["#text"]` for simpleContent.
- Primitives: `src/constants.js` contains `XSD_TYPE_TO_JS`. Generator must not `new` primitives (e.g., `xs:string` is a plain string).
- xs:any: the codebase preserves raw xml2js nodes. `fromXML()` attaches a non-enumerable `__rawChildrenMap` built from the raw xml2js `.$$` children; the constructor for `isAny` properties prefers this map so original subtree is preserved. `toObject()` expands the map via `normalizeXml2js` and `toXML()` can emit fragments via `xml2jsChildToXML`.

Metadata shape (used by Base and generated classes)

- Each generated class exposes `static __getXSDMeta()` returning entries with:
  - `xmlName` (string)
  - `xsdType` (string | undefined)
  - `isAttribute` (boolean)
  - `isList` (boolean)
  - `isAny` (boolean)

Editing guidelines for common tasks

- Change parsing: update `src/xmlNormalizer.js` and the local normalizer inside `template/base.js` (template must stay self-contained for outputs).
- Change constructors: edit `src/generator.js` `buildConstructor` logic and update `test/generated-unit/` fixtures.
- Add XSD support: edit `src/propertyExtractor.js`, then regenerate samples and run tests.
- Change runtime helpers: edit `template/base.js` (not test-generated Base) and update `test/generated-unit/Base.js` while iterating.

Debugging tips

- Template mistakes propagate to generated code; regenerate outputs and run `node` on the generated files to detect syntax errors quickly.
- Serialization issues often come from not coercing wrapper objects—use the `stringifyValue()` approach in the template to force string values before emitting XML.
- For xs:any roundtrips inspect the instance's `__rawChildrenMap` and output of `toObject()`; `console.dir(obj, { depth: 4 })` is handy in tests.

Developer workflows

- Add tests in `test/` or update `test/generated-unit/` when generator changes. Run `npm test` frequently.
- Use `node ./src/main.js` to generate into `examples/generated` and compare against `test/generated-unit`.

Notes for AI agents

- Make small, targeted edits; large template changes can break many tests.
- When changing serialization, update both `template/base.js` and `test/generated-unit/Base.js` in tandem to iterate safely.
- Keep xml2js explicitChildren/preserveChildrenOrder behavior intact; tests and semantics rely on it.
